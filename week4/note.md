# 第四周

## 第三章 低级输入输出

​	使用UNIX的输入输出系统调用。这些系统调用习惯上称为低级I/O函数。低级I/O函数对文件描述字进行操作,其中有一些是实现标准I/O函数的初等函数;另外些则执行低级控制操作,没有相对应的标准I/O函数。

### 1. 文件描述字的打开、创建和关闭

​	类似于标准流，每一个进程也会预先打开三个文件描述字：0、1和2，它们分别对应于标准输入、标准输出和标准错误输出。分别用符号常量`STDIN_FILENO,STDOUT_FILENO,STDERR_FIFENO`表示。

​	函数`open()`或`create()`用于打开或创建一个文件描述字。

```c
#include <sys/types.h>
#include <sys/stat.h>
#include <fctnl.h>

int open(const char *filename,int flags[,mode_t mode]);
int create(const char *filename,mode_t mode);
```

​	`open()`用于打开或创建一个文件,参数filename指明文件;flags给出文件的打开方式,它是一个位串,其值由表3-1列出的各种常数做位或运算(C中的“|”操作)而形成;mode是可选参数,给出文件的访问方式,其值由表4-6列出的各种常数做位或运算而形成,仅当创建文件时才用它指明新文件的访问方式位,其他情况下提供该参数不起作用。

​	`open()`调用成功返回为文件 filename新创建的一个描述字,同时文件位置定位于文件的开始处:调用失败则不会创建或修改文件

​	`open()`返回的描述字一定是当前最小未使用的描述字。这个特征特别有用,例如,如果一个程序关闭了它的标准输出,然后再调用`open()`创建或打开另一个文件,则标准输出使用的文件描述字1将成为这个新打开文件的描述字,从而使得标准输出可以重新定向至不同的文件或设备。在3-4节可看到利用这一特征的例子。

![](http://117.78.7.207:6789/imgs/2020/11/b1ce6127d9477f46.png)

​	`open()`返回的文件描述字是唯一的,它不会由正在运行的其他进程所共享。如果两个进程同时打开同一个文件,系统会保证各自有自己的文件描述字。如果这两个进程都写这个文件,它们将按照自己的文件位置来写。写入的数据不会交错地记录在文件内,而是一个被另一个所覆盖。为了避免写入的数据被覆盖,可以利用文件锁(10.1节)来协调。

​	函数`create()`用于创建一个新文件。调用

​	`fd=create(filename,mode);`

等价于

​	`fd=open(filename,O_WRONLY|O_CREAT|O_TRUNC,mode);`

函数`close()`用于关闭已打开的文件描述字。

```c
#include <unistd.h>
int close(int filedes);
```

关闭文件描述字意味着下述一系列动作：

- 释放描述字`filedes`，此描述字可被后继调用的`open()`再次使用。

- 释放进程在此文件上占用的所有文件锁。

- 当与管道或FIFO相连的所有文件描述字均被关闭时，废弃任何还在管道或FIFO中的数据。
​	当进程终止时，UNIX内核会自动的关闭该进程打开的所有文件，因此许多应用利用这一特征而不明显地调用`close()`关闭文件。
![](http://117.78.7.207:6789/imgs/2020/11/3384c89f8cc591aa.png)







### inode vnode

`inode`物理控制信息，直接修改文件内容

`vnode`为用户提供唯一许可的操作方式